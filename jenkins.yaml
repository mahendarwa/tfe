stage('Kill service') {
    agent { label 'consumer-panel-services-agent_prod_daylnxcpsp023' }
    steps {
        script {
            sh """
                set +e
                echo "üîç Searching for PID running on port ${env.server_port} for user ${env.adminuser}"

                pid=\$(ps -u ${env.adminuser} -o pid= | xargs -r -I {} sh -c 'ps -o args= -p {} | grep -q "Dserver.port=${env.server_port}" && echo {}')
                status=\$?

                if [ \$status -ne 0 ]; then
                    echo "‚ö†Ô∏è  ps or grep failed with status \$status"
                    exit \$status
                fi

                if [ -n "\$pid" ]; then
                    echo "üõë Found PID: \$pid. Attempting to kill..."
                    kill -9 \$pid
                    kill_status=\$?
                    if [ \$kill_status -eq 0 ]; then
                        echo "‚úÖ Process \$pid killed successfully."
                    else
                        echo "‚ùå Failed to kill PID \$pid. Exit code: \$kill_status"
                        exit \$kill_status
                    fi
                else
                    echo "‚ÑπÔ∏è  No matching process found for user ${env.adminuser} on port ${env.server_port}."
                fi
            """
        }
    }
}
