name: "PAT QA Docker"

on:
  workflow_dispatch:

jobs:
  checkout-014:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          ref: "trn/feature/jan31"

  server-014:
    runs-on: self-hosted
    needs: checkout-014
    steps:
      - name: Set Up Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set JAVA_HOME
        run: |
          export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
          echo "JAVA_HOME is set to $JAVA_HOME"
          java -version

      - name: Clear Gradle Cache
        run: |
          rm -rf ~/.gradle/caches

      - name: Set Gradlew Permissions
        run: |
          chmod +x /home/bambscm1/actions-runner/_work/bcc-patservice/bcc-patservice/gradlew
          chmod +x /home/bambscm1/actions-runner/_work/bcc-patservice/bcc-patservice/ddrgenerator/gradlew

      - name: Upgrade Gradle Wrapper
        run: |
          cd /home/bambscm1/actions-runner/_work/bcc-patservice/bcc-patservice
          ./gradlew wrapper --gradle-version 8.2.1

      - name: Build and Deploy on Server 014
        env:
          ARTIFACTORY_USER: ${{ secrets.ARTIFACTORY_USER }}
          ARTIFACTORY_PASS: ${{ secrets.ARTIFACTORY_PASS }}
        run: |
          cd /home/bambscm1/actions-runner/_work/bcc-patservice/bcc-patservice/ddrgenerator
          ./gradlew clean build -x test --no-daemon --stacktrace

          docker kill ddrgenerator || true
          docker rm ddrgenerator || true
          docker image rm -f ddrgenerator || true

          cd /home/bambscm1/actions-runner/_work/bcc-patservice/bcc-patservice/ddrgenerator
          docker build -t ddrgenerator --file Dockerfile .

          cd /home/bambscm1/actions-runner/_work/bcc-patservice/bcc-patservice/cicd/docker-compose/qa
          docker-compose -f docker-compose.primary.yml up -d
