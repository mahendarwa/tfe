name: "Aggengine Image Build"

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag to apply to the latest commit'
        required: true
        type: string

jobs:
  kv:
    runs-on: self-hosted
    steps:
      - name: fetch secrets
        id: kv
        uses: niq-actions/az-kv-management@v2.3.1
        env:
          AZURE_CLIENT_ID: ${{ secrets.OMNSHO_SP_NP_APPID }}
          AZURE_CLIENT_SECRET: ${{ secrets.OMNSHO_SP_NP_PASSWORD }}
          AZURE_TENANT_ID: ${{ secrets.OMNSHO_SP_NP_TENANT }}
        with:
          kv_name: OMNSHOKVAUTOUS
          summary: false
          type: get
          secretname: artifactory-password
    outputs:
      artifactory-password: ${{ steps.kv.outputs.artifactory-password }}

  tagging-job:
    runs-on: self-hosted
    needs: [kv]
    steps:
      - name: Checkout SCM
        uses: actions/checkout@v3

      - name: Get Latest Commit ID
        run: |
          latest_commit=$(git rev-parse HEAD)
          echo "Latest Commit ID: $latest_commit"
          echo "commit_id=$latest_commit" >> $GITHUB_ENV

      - name: Tag the Commit
        run: |
          git tag ${{ github.event.inputs.tag_name }} ${{ env.commit_id }}
          git push origin ${{ github.event.inputs.tag_name }}

  ccoe-build-testing:
    if: github.event_name == 'workflow_dispatch' && startsWith(github.ref, 'refs/heads/release/') && github.ref != 'refs/heads/release/scheduled'
    needs: [kv, tagging-job]
    runs-on: self-hosted
    uses: niq-actions/niq-build/.github/workflows/build.yml@v3
    secrets: inherit
    with:
      image_name: "aggengapi"
      dev_acr: "omnshodevacreastus2.azurecr.io"
      prod_acr: "omnshoprodacreastus2.azurecr.io"
      build-args: |
        BRANCH=${{ github.event.inputs.tag_name }}  # Pass the tag_name as the BRANCH
        ARTIFACTORY_USERNAME=omnishopper2srv
        ARTIFACTORY_PASSWORD=${{ needs.kv.outputs.artifactory-password }}
      push_image: true
      wiz_feature_scan: false
      wiz_username: WIZ_USERNAME
      wiz_password: WIZ_PASSWORD
      service_principal: OMNSHO_SP_NP
      path: "./Dockerfile"
      lfs: false
