name: "Aggengine Image Build"

on:
  push:
    branches:
      - "feature/*"
      - "release/testing"
    paths-ignore: 
      - ".github/*"
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      commit_id:
        description: 'Commit ID to apply to the build'
        required: false
        type: string

jobs:
  kv:
    runs-on: self-hosted
    steps:
      - name: fetch secrets
        id: kv
        uses: niq-actions/az-kv-management@v2.3.1
        env:
          AZURE_CLIENT_ID: ${{ secrets.OMNSHO_SP_NP_APPID }}
          AZURE_CLIENT_SECRET: ${{ secrets.OMNSHO_SP_NP_PASSWORD }}
          AZURE_TENANT_ID: ${{ secrets.OMNSHO_SP_NP_TENANT }}
        with:
          kv_name: OMNSHOKVAUTOUS
          summary: false
          type: get
          secretname: artifactory-password
    outputs:
      artifactory-password: ${{ steps.kv.outputs.artifactory-password }}

  CCOE-BUILD-Feature:
    if: startsWith(github.ref, 'refs/heads/feature/')
    needs: [kv]
    uses: niq-actions/niq-build/.github/workflows/build.yml@v3
    with:
      image_name: "aggengapi"
      dev_acr: "omnshodevacreastus2.azurecr.io"
      prod_acr: "omnshoprodacreastus2.azurecr.io"
      build-args: |
        BRANCH=feature-${{ github.ref_name }}
        ARTIFACTORY_USERNAME=omnishopper2srv
        ARTIFACTORY_PASSWORD=${{ needs.kv.outputs.artifactory-password }}
      push_image: true
      wiz_feature_scan: false
      wiz_username: ${{ secrets.WIZ_USERNAME }}
      wiz_password: ${{ secrets.WIZ_PASSWORD }}
      service_principal: ${{ secrets.OMNSHO_SP_NP }}
      path: "./Dockerfile"
      lfs: false

  CCOE-BUILD-Testing-Prepare:
    if: github.event_name == 'workflow_dispatch' && startsWith(github.ref, 'refs/heads/release/') && github.ref != 'refs/heads/release/scheduled'
    needs: [kv]
    runs-on: self-hosted
    steps:
      - name: Checkout SCM
        uses: actions/checkout@v3

      - name: Get Latest Commit ID
        id: get-latest-commit
        run: |
          latest_commit=${{ github.event.inputs.commit_id || '$(git rev-parse HEAD)' }}
          echo "Latest Commit ID: $latest_commit"
          echo "commit_id=$latest_commit" >> $GITHUB_ENV

  CCOE-BUILD-Testing:
    if: github.event_name == 'workflow_dispatch' && startsWith(github.ref, 'refs/heads/release/') && github.ref != 'refs/heads/release/scheduled'
    needs: [kv, CCOE-BUILD-Testing-Prepare]
    uses: niq-actions/niq-build/.github/workflows/build.yml@v3
    with:
      image_name: "aggengapi"
      dev_acr: "omnshodevacreastus2.azurecr.io"
      prod_acr: "omnshoprodacreastus2.azurecr.io"
      build-args: |
        BRANCH=testing-${{ env.commit_id }}
        ARTIFACTORY_USERNAME=omnishopper2srv
        ARTIFACTORY_PASSWORD=${{ needs.kv.outputs.artifactory-password }}
      push_image: true
      wiz_feature_scan: false
      wiz_username: ${{ secrets.WIZ_USERNAME }}
      wiz_password: ${{ secrets.WIZ_PASSWORD }}
      service_principal: ${{ secrets.OMNSHO_SP_NP }}
      path: "./Dockerfile"
      lfs: false
