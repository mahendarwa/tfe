name: "Aggengine Image Build"

on:
  push:
    branches:
      - "feature/*"
      - "release/testing"
    paths-ignore: 
      - ".github/*"
    tags:
      - '*'

jobs:
  kv:
    runs-on: self-hosted
    steps:
      - name: fetch secrets
        id: kv
        uses: niq-actions/az-kv-management@v2.3.1
        env:
            AZURE_CLIENT_ID: ${{ secrets.OMNSHO_SP_NP_APPID }}
            AZURE_CLIENT_SECRET: ${{ secrets.OMNSHO_SP_NP_PASSWORD }}
            AZURE_TENANT_ID: ${{ secrets.OMNSHO_SP_NP_TENANT }}
        with:
            kv_name: OMNSHOKVAUTOUS
            summary: false
            type: get
            secretname: artifactory-password
    outputs:
      artifactory-password: ${{ steps.kv.outputs.artifactory-password }}

  CCOE-BUILD:
    if: startsWith(github.ref, 'refs/heads/feature/')
    needs: [kv]
    uses: niq-actions/niq-build/.github/workflows/build.yml@v3
    with:
      image_name: "aggengapi"
      dev_acr: "omnshodevacreastus2.azurecr.io"
      prod_acr: "omnshoprodacreastus2.azurecr.io"
      build-args: |
        BRANCH=${{ github.ref_name }}
        ARTIFACTORY_USERNAME=omnishopper2srv
        ARTIFACTORY_PASSWORD=${{ needs.kv.outputs.artifactory-password }}
      push_image: true
      wiz_feature_scan: false
      wiz_username: WIZ_USERNAME
      wiz_password: WIZ_PASSWORD
      service_principal: OMNSHO_SP_NP
      path: "./Dockerfile"
      lfs: false
    secrets: inherit

  build-scheduled:
    if: github.ref == 'refs/heads/release/testing'
    needs: [kv]
    uses: niq-actions/niq-build/.github/workflows/build.yml@v3
    with:
      image_name: "aggengapi"
      dev_acr: "omnshodevacreastus2.azurecr.io"
      prod_acr: "omnshoprodacreastus2.azurecr.io"
      build-args: |
        BRANCH="00-00-04"
        ARTIFACTORY_USERNAME=omnishopper2srv
        ARTIFACTORY_PASSWORD=${{ needs.kv.outputs.artifactory-password }}
      push_image: true
      wiz_feature_scan: false
      wiz_username: WIZ_USERNAME
      wiz_password: WIZ_PASSWORD
      service_principal: OMNSHO_SP_NP
      path: "./Dockerfile"
      lfs: false
    secrets: inherit

  build-on-tag-push:
    if: github.ref_type == 'tag'
    needs: [kv]
    uses: niq-actions/niq-build-validation@v3.1.0  # Using the reusable workflow at the job level
    secrets: inherit
    with:
      image_name: "aggengapi"
      dev_acr: "omnshodevacreastus2.azurecr.io"
      prod_acr: "omnshoprodacreastus2.azurecr.io"
      build-args: |
        BRANCH=${{ github.ref_name }}
        ARTIFACTORY_USERNAME=omnishopper2srv
        ARTIFACTORY_PASSWORD=${{ needs.kv.outputs.artifactory-password }}
      push_image: true
      wiz_feature_scan: false
      wiz_username: WIZ_USERNAME
      wiz_password: WIZ_PASSWORD
      service_principal: OMNSHO_SP_NP
      path: "./Dockerfile"
      lfs: false
