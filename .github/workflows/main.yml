name: "POD Image Build"

on:
  push:
    branches:
      - "release/main"
    paths-ignore: 
      - ".github/*"

  workflow_dispatch:

jobs:
  kv:
    runs-on: self-hosted
    steps:
      - name: fetch secrets
        id: kv
        uses: niq-actions/az-kv-management@v2.3.1
        env:
          AZURE_CLIENT_ID: ${{ secrets.OMNSHO_SP_NP_APPID }}
          AZURE_CLIENT_SECRET: ${{ secrets.OMNSHO_SP_NP_PASSWORD }}
          AZURE_TENANT_ID: ${{ secrets.OMNSHO_SP_NP_TENANT }}
        with:
          kv_name: OMNSHOKVAUTOUS
          summary: false
          type: get
          secretname: artifactory-password
    outputs:
      artifactory-password: ${{ steps.kv.outputs.artifactory-password }}

  build-on-tag-push:
    if: github.ref_type == 'tag'
    needs: [kv]
    runs-on: self-hosted
    steps:
      - name: Print GitHub ref name
        run: |
          echo "GitHub Ref Name: ${{ github.ref_name }}"

      - name: Run build
        uses: niq-actions/niq-build/.github/workflows/build.yml@v3
        with:
          image_name: "aggengapi"
          dev_acr: "omnshodevacreastus2.azurecr.io"
          prod_acr: "omnshoprodacreastus2.azurecr.io"
          build-args: |
            BRANCH=${{ github.ref_name }}
            ARTIFACTORY_USERNAME=omnishopper2srv
            ARTIFACTORY_PASSWORD=${{ needs.kv.outputs.artifactory-password }}
          push_image: true
          wiz_feature_scan: false
          wiz_username: ${{ secrets.WIZ_USERNAME }}
          wiz_password: ${{ secrets.WIZ_PASSWORD }}
          service_principal: OMNSHO_SP_NP
          path: "./Dockerfile"
          lfs: false
