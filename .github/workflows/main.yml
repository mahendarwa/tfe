name: Kill and Restart PAT Service

on:
  workflow_dispatch:
    inputs:
      prod_envi:
        description: 'Select the production environment'
        required: true
        type: choice
        options:
          - pfnz
          - pfid
          - pfth
          - pfph
          - pfsg
          - pfhk
          - pfau
          - pfbp
          - omau
          - pfgb
          - pffi
          - pfpt
          - pfes
          - pffr
          - pfde
          - pfch
          - pfit
          - omca
          - pfca
          - pfco
          - pfpr
          - pfcl
          - pfbr
          - pfmx
          - pfxu
          - pfus

jobs:
  kill_and_restart:
    runs-on: ubuntu-latest
    steps:
      - name: Map Environment Variables
        id: mapenv
        run: |
          declare -A USERS=(
            [pfnz]="pfnzsup3|daylnxcpsp023|8152"
            [pfid]="pfidsup3|daylnxcpsp023|8159"
            [omca]="omcasup3|daylnxcpsp014|8151"
            [pfhk]="pfhksup3|daylnxcpsp023|8163"
            [pffi]="pffisup3|daylnxcpsp022|8154"
            [pfco]="pfcosup3|daylnxcpsp014|8155"
            [pfpr]="pfprsup3|daylnxcpsp014|8156"
            [pfcl]="pfclsup3|daylnxcpsp014|8157"
            [pfbr]="pfbrsup3|daylnxcpsp014|8158"
            [pfca]="pfcasup3|daylnxcpsp014|8150"
            [pfph]="pfphsup3|daylnxcpsp023|8160"
            [pfth]="pfthsup3|daylnxcpsp023|8161"
            [pfsg]="pfsgsup3|daylnxcpsp023|8162"
            [pfmx]="pfmxsup3|daylnxcpsp014|8164"
            [pfxu]="pfxusup3|daylnxcpsp014|8165"
            [pfus]="pfussup3|daylnxcpsp014|8166"
            [pfra]="pfrasup3|daylnxcpsp022|8167"
            [pfgb]="pfgbsup3|daylnxcpsp022|8153"
            [pfau]="pfausup3|daylnxcpsp023|8174"
            [pfpt]="pfptsup3|daylnxcpsp022|8168"
            [pfes]="pfessup3|daylnxcpsp022|8169"
            [pffr]="pffrsup3|daylnxcpsp022|8170"
            [pfde]="pfdesup3|daylnxcpsp022|8171"
            [pfch]="pfchsup3|daylnxcpsp022|8172"
            [pfit]="pfitsup3|daylnxcpsp022|8173"
            [pfbp]="pfbpsup3|daylnxcpsp023|8175"
            [omau]="omausup3|daylnxcpsp023|8176"
          )

          IFS='|' read -r adminuser server port <<< "${USERS[${{ github.event.inputs.prod_envi }}]}"

          if [ -z "$adminuser" ]; then
            echo "Invalid environment value"
            exit 1
          fi

          echo "adminuser=$adminuser" >> "$GITHUB_OUTPUT"
          echo "server=$server" >> "$GITHUB_OUTPUT"
          echo "port=$port" >> "$GITHUB_OUTPUT"

      - name: SSH to Kill and Restart PAT Service
        env:
          ADMINUSER: ${{ steps.mapenv.outputs.adminuser }}
          SERVER: ${{ steps.mapenv.outputs.server }}
          PORT: ${{ steps.mapenv.outputs.port }}
          PROD_ENVI: ${{ github.event.inputs.prod_envi }}
        run: |
          echo "Executing SSH operations on $SERVER:$PORT"

          ssh -o StrictHostKeyChecking=no ${ADMINUSER}@${SERVER}.enterprisenet.org <<EOF
          echo "Checking for process listening on port ${PORT}..."
          pid=\$(lsof -i :${PORT} -sTCP:LISTEN -t)
          if [ -n "\$pid" ]; then
            echo "Found PID: \$pid"
            kill -9 \$pid
            echo "Killed PID \$pid"
          else
            echo "No process found on port ${PORT}"
          fi
          cd /${PROD_ENVI}/bin || echo "Directory not found"
          nohup ./startPATservice_${PROD_ENVI}.sh > /dev/null 2>&1 &
          EOF
