name: Read Environment Config

on:
  push:
    branches:
      - feature/github
      - main

jobs:
  read-config:
    runs-on: self-hosted
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install yq
        run: |
          sudo curl -L https://github.com/mikefarah/yq/releases/download/v4.6.1/yq_linux_amd64 -o /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Set Environment Variable for Config File
        run: |
          CONFIG_FILE="${{ github.workspace }}/usdev.jenkins.yaml"
          echo "CONFIG_FILE=${CONFIG_FILE}" >> $GITHUB_ENV
          echo "Set CONFIG_FILE to: ${CONFIG_FILE}"

      - name: Print Config File Path
        run: |
          echo "Jenkins Config File Path: ${{ env.CONFIG_FILE }}"

      - name: Read YAML Config and Print Deploy Section
        id: read_yaml
        run: |
          echo "Attempting to read the 'deploy' section from the YAML file: ${{ env.CONFIG_FILE }}"
          yq eval '.deploy' "${{ env.CONFIG_FILE }}" > deploy_output.yaml
          cat deploy_output.yaml

      - name: Print Deploy Section Contents
        run: |
          echo "Printing Deploy Section Contents:"
          cat deploy_output.yaml
