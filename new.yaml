- name: Debug env for SSH
  env:
    ADMIN_USR: ${{ vars.ADMIN_USR }}             # or: ${{ secrets.ADMIN_USR }}
    REMOTE_HOST: daylnxcpsq014.enterprisenet.org # set host here
  run: |
    set -x
    echo "matrix.env_name=${{ matrix.env_name }}"
    echo "ADMIN_USR=${ADMIN_USR:-<EMPTY>}"
    echo "REMOTE_HOST=${REMOTE_HOST:-<EMPTY>}"
    ls -l ~/.ssh || true
    ssh -V

- name: SSH sanity check
  env:
    ADMIN_USR: ${{ vars.ADMIN_USR }}           
    REMOTE_HOST: daylnxcpsq014.enterprisenet.org
  run: |
    set -e
    : "${ADMIN_USR:?ADMIN_USR is empty – set vars.ADMIN_USR or secrets.ADMIN_USR}"
    : "${REMOTE_HOST:?REMOTE_HOST is empty}"
    ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no \
        -i ~/.ssh/vscode \
        "${ADMIN_USR}@${REMOTE_HOST}" "echo Connected OK: \$(whoami)@\$(hostname)"


- name: Copy ETL assets to remote
  env:
    ADMIN_USR: ${{ vars.ADMIN_USR }}
    REMOTE_HOST: daylnxcpsq014.enterprisenet.org
  run: |
    ssh -o StrictHostKeyChecking=no -i ~/.ssh/vscode "${ADMIN_USR}@${REMOTE_HOST}" bash -s <<'EOF'
      set -e
      chmod 750 /${{ matrix.env_name }}/bin
      chmod -R 750 /${{ matrix.env_name }}/bin/* || true
      cp -rv /tmp/actions/* /${{ matrix.env_name }}/bin/
      find ${ORG_PATH}ETL/config_pg/SQA/${PATH_ENV} -type f -exec cp -v {} /${{ matrix.env_name }}/bin/etl/config_pg/ \;
      cp -rvf ${ORG_PATH}ETL/scripts_pg/* /${{ matrix.env_name }}/bin/etl/scripts_pg/
      cp -rvf ${ORG_PATH}ETL/sql_pg/*     /${{ matrix.env_name }}/bin/etl/sql_pg/
      cp -rvf ${ORG_PATH}ETL/ref_pg/*     /${{ matrix.env_name }}/bin/etl/ref_pg/
      cp -rvf ${ORG_PATH}unix/PFW_UNIX/shellscripts_pg/* /${{ matrix.env_name }}/bin/
EOF


- name: Inject auth_key secret into INI
  env:
    ADMIN_USR: ${{ vars.ADMIN_USR }}
    REMOTE_HOST: daylnxcpsq014.enterprisenet.org
    SECRET_QA_AUTH: ${{ secrets.SECRET_QA_AUTH }}
  run: |
    set -e
    : "${SECRET_QA_AUTH:?SECRET_QA_AUTH is empty – add repo secret}"
    REMOTE_PATH="/${{ matrix.env_name }}/bin/etl/config_pg/pat_etl_config.ini"
    # Escape / & \ so sed replacement cannot break
    SAFE_SECRET="$(printf '%s' "$SECRET_QA_AUTH" | sed -e 's/[\/&]/\\&/g' -e 's/\\/\\\\/g')"

    ssh -o StrictHostKeyChecking=no -i ~/.ssh/vscode "${ADMIN_USR}@${REMOTE_HOST}" \
      "set -e;
       test -f '$REMOTE_PATH' || { echo 'ERROR: ini not found: $REMOTE_PATH'; exit 1; }
       if grep -q '^auth_key=' '$REMOTE_PATH'; then
         sed -i 's|^auth_key=.*|auth_key=$SAFE_SECRET|' '$REMOTE_PATH'
       else
         printf '\nauth_key=%s\n' '$SAFE_SECRET' >> '$REMOTE_PATH'
       fi;
       echo 'Updated:'; nl -ba '$REMOTE_PATH' | sed -n '/auth_key=/p'"

- name: Fix permissions
  env:
    ADMIN_USR: ${{ vars.ADMIN_USR }}
    REMOTE_HOST: daylnxcpsq014.enterprisenet.org
  run: |
    ssh -o StrictHostKeyChecking=no -i ~/.ssh/vscode "${ADMIN_USR}@${REMOTE_HOST}" "
      chmod -R 750 /${{ matrix.env_name }}/bin/* || true
      chmod -R 550 /${{ matrix.env_name }}/bin/* || true
      chgrp -R stdd /${{ matrix.env_name }}/bin/* || true
      chmod -R 550 /${{ matrix.env_name }}/bin || true
    "
